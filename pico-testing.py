from machine import Pin, ADC
import utime
import time
import struct

step = Pin(5)
direction = Pin(6, Pin.OUT)

# To control speed just modify the amount/value of nop[dely amount 0-31].
@rp2.asm_pio(set_init=rp2.PIO.OUT_LOW)
def move():
    wrap_target()
    #mov(y, osr)
    #pull(noblock)
    mov(x, osr)
    #jmp(x_not_y, 'new')
    label('loop')
    jmp(x_dec, 'loop')
    set(pins, 1)   [10]
    set(pins, 0)
    wrap()


"""Instantiate a state machine with the move
program, at 100000Hz, with set base to step pin."""
motor = rp2.StateMachine(0, move, freq=5_000_000, set_base=step)

powers = [-2**18, 10000, 5000, 3333, 2500, 2000, 1666, 1428, 1402, 1630, 1948, 2420, 3193, 4692, 8839, 76180, -11511, -13189, 41355, 8052, 4460, 3084, 2357, 1907, 1602, 1615, 1926, 2386, 3133, 4564, 8396, 52342, -12361, -5528, -5934, -14594, 31766, 7605, 4320, 3016, 2317, 1909, 1956, 2431, 3213, 4734, 8992, 89217, -11262, -5296, -3462, -3173, -4087, -6913, -22397, 18066, 6437, 3916, 2814, 2207, 2215, 2714, 3725, 5938, 14621, -31639, -7598, -4317, -3015, -2318, -2114, -2258, -2916, -4117, -7000, -23335, 17498, 6363, 4309, 3993, 4026, 4288, 6751, 20785, -19271, -6583, -3970, -2841, -2212, -2841, -3970, -4018, -2866, -2227, -2866, -4018, -6717, -20462, 19557, 6994, 23277, -17532, -6367, -5380, -11648, 70677, 8822, 74898, -11540, -5357, -3488, -2586, -3381, -5110, -10449, 232256, 9587, 4894, 3286, 2515, 2141, 1975, 1941, 2012, 2188, 2499, 3011, 3886, 5564, 9764, 36053, -23464, -9300, -6013, -4574, -3782, -3291, -2965, -2740, -2582, -2471, -2393, -2343, -2313, -2301, -2304, -2321, -2349, -2390, -2441, -2504, -2579, -2665, -2763, -2874, -3000, -3140, -3298, -3474, -3670, -3889, -4134, -4408, -4716, -5061, -5450, -5890, -6389, -6957, -7608, -8357, -9225, -10237, -11428, -12841, -14538, -16602, -19151, -22361, -26500, -32000, -39606, -50720, -68324, -100094, -173547, -517746, 657780, 216818, 135804, 102108, 83883, 72645, 65169, 59962, 56242, 53559, 51636, 50296, 49422, 48933, 48773, 48905, 49301, 49946, 50828, 51944, 53294, 54884, 56723, 58823, 61203, 63883, 66890, 70255, 74015, 78215, 82906, 88151, 94021, 100605, 108004, 116344, 125774, 136478, 148681, 162652, 178746, 197400, 219177, 244810, 275275, 312500, 356482, 411663, 481287, 571278, 691265, 857946, 1103053, 1495141, 2214732, 3940361]

def write(speed):
    if speed > 0:
        direction.value(1)
    else:
        direction.value(0)
    #speed = (1/speed)*(0.1)*(1000000)*(5)
    try:
        speed = int(500_000/speed)
    except ZeroDivisionError:
        speed = 2**18 if speed > 0 else -2**18
    print(motor.tx_fifo())
    motor.put(speed if speed > 0 else -speed)
    motor.exec("pull()")
dt = 0.25
motor.active(1)
start = time.ticks_us()
for i in (
    list(range(0, 310, 10))
  + list(range(300, -310, -10))
  + list(range(-310, 0, 10))
    )*3:
    write(i)
    while time.ticks_us() - start < 5000: pass
    start = time.ticks_us()


# for i in range(-100, 200):
#     start = time.ticks_ms()
#     write(i)
#     while time.ticks_ms()-start < 10:
#         pass
    
motor.active(0)

